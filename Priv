import sqlite3
import logging
import asyncio
from datetime import datetime, date, timedelta, time
import matplotlib.pyplot as plt
import matplotlib
matplotlib.use('Agg')  # –î–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ GUI
import io
import random
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –¢–û–ö–ï–ù –ù–ê –°–í–û–ô
BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"

# –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã
MOTIVATIONAL_QUOTES = [
    "üéØ –ú–∞–ª–µ–Ω—å–∫–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –±–æ–ª—å—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º!",
    "üí™ –°–µ–≥–æ–¥–Ω—è —Ç–æ—Ç –¥–µ–Ω—å, –∫–æ–≥–¥–∞ —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –ª—É—á—à–µ, —á–µ–º –≤—á–µ—Ä–∞!",
    "üöÄ –£—Å–ø–µ—Ö ‚Äî —ç—Ç–æ —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π, –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã—Ö –∏–∑–æ –¥–Ω—è –≤ –¥–µ–Ω—å!",
    "üåü –¢—ã –±–ª–∏–∂–µ –∫ —Å–≤–æ–µ–π —Ü–µ–ª–∏, —á–µ–º –±—ã–ª –≤—á–µ—Ä–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
    "üî• –°–∞–º—ã–π –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –±—ã–ª –≥–æ–¥ –Ω–∞–∑–∞–¥. –°–ª–µ–¥—É—é—â–∏–π –ª—É—á—à–∏–π ‚Äî —Å–µ–π—á–∞—Å!",
    "üåà –ù–µ–≤–∞–∂–Ω–æ, –∫–∞–∫ –º–µ–¥–ª–µ–Ω–Ω–æ —Ç—ã –¥–≤–∏–∂–µ—à—å—Å—è, –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è!",
    "üéâ –ö–∞–∂–¥–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ ‚Äî —ç—Ç–æ —à–∞–≥ –∫ –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–∏ —Å–µ–±—è!",
    "üí´ –¢—ã –¥–µ–ª–∞–µ—à—å —ç—Ç–æ! –û–¥–∏–Ω –¥–µ–Ω—å –∑–∞ —Ä–∞–∑, –æ–¥–Ω–∞ –ø—Ä–∏–≤—ã—á–∫–∞ –∑–∞ —Ä–∞–∑!",
    "‚≠êÔ∏è –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –∫–ª—é—á –∫ –≤–µ–ª–∏–∫–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º!",
    "üå± –í–µ–ª–∏–∫–∏–µ –¥–µ—Ä–µ–≤—å—è –≤—ã—Ä–∞—Å—Ç–∞—é—Ç –∏–∑ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å–µ–º—è–Ω. –¢–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏ ‚Äî —ç—Ç–æ —Å–µ–º–µ–Ω–∞ —Ç–≤–æ–µ–≥–æ —É—Å–ø–µ—Ö–∞!"
]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–≤—ã—á–µ–∫
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_habits (
            user_id INTEGER,
            habit_name TEXT,
            created_date DATE,
            reminder_time TEXT DEFAULT '09:00',
            PRIMARY KEY (user_id, habit_name)
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS habit_progress (
            user_id INTEGER,
            habit_name TEXT,
            date DATE,
            status TEXT DEFAULT 'pending',
            PRIMARY KEY (user_id, habit_name, date)
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_settings (
            user_id INTEGER PRIMARY KEY,
            daily_reminder BOOLEAN DEFAULT TRUE,
            reminder_time TEXT DEFAULT '09:00',
            motivational_quotes BOOLEAN DEFAULT TRUE
        )
    ''')
    
    conn.commit()
    conn.close()

# –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É
def get_motivational_quote():
    return random.choice(MOTIVATIONAL_QUOTES)

# –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
def create_progress_chart(user_id, habit_name, days=30):
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ days –¥–Ω–µ–π
    end_date = date.today()
    start_date = end_date - timedelta(days=days-1)
    
    dates = []
    completion_rates = []
    
    for i in range(days):
        current_date = start_date + timedelta(days=i)
        dates.append(current_date)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
        cursor.execute(
            'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
            (user_id, habit_name, current_date.isoformat())
        )
        result = cursor.fetchone()
        
        if result and result[0] == "completed":
            completion_rates.append(1)
        else:
            completion_rates.append(0)
    
    conn.close()
    
    # –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    plt.figure(figsize=(12, 6))
    
    # –ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    plt.plot(dates, completion_rates, 'o-', linewidth=2, markersize=8, color='#4CAF50', label='–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ')
    
    # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
    plt.fill_between(dates, completion_rates, alpha=0.3, color='#4CAF50')
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    plt.title(f'–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏–≤—ã—á–∫–∏: {habit_name}\n–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π', fontsize=14, fontweight='bold', pad=20)
    plt.xlabel('–î–∞—Ç–∞', fontsize=12)
    plt.ylabel('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ', fontsize=12)
    plt.ylim(-0.1, 1.1)
    plt.yticks([0, 1], ['‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ'])
    plt.grid(True, alpha=0.3)
    plt.xticks(rotation=45)
    plt.tight_layout()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤ –±—É—Ñ–µ—Ä
    buf = io.BytesIO()
    plt.savefig(buf, format='png', dpi=80, bbox_inches='tight')
    buf.seek(0)
    plt.close()
    
    return buf

# –û—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
async def send_daily_reminders(context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
    cursor.execute('SELECT user_id FROM user_settings WHERE daily_reminder = TRUE')
    users = cursor.fetchall()
    
    for user in users:
        user_id = user[0]
        today = date.today().isoformat()
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute('SELECT habit_name FROM user_habits WHERE user_id = ?', (user_id,))
        habits = cursor.fetchall()
        
        if habits:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è
            pending_habits = []
            for habit in habits:
                habit_name = habit[0]
                cursor.execute(
                    'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
                    (user_id, habit_name, today)
                )
                result = cursor.fetchone()
                
                if not result or result[0] != "completed":
                    pending_habits.append(habit_name)
            
            if pending_habits:
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º
                habits_text = "\n".join([f"‚Ä¢ {habit}" for habit in pending_habits])
                message = (
                    f"üìã *–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!*\n\n"
                    f"–°–µ–≥–æ–¥–Ω—è –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:\n{habits_text}\n\n"
                    f"üí´ {get_motivational_quote()}\n\n"
                    f"–ù–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è! ‚ú®"
                )
                
                try:
                    await context.bot.send_message(
                        chat_id=user_id,
                        text=message,
                        parse_mode='Markdown'
                    )
                except Exception as e:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
    
    conn.close()

# –û—Ç–ø—Ä–∞–≤–∫–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async def send_motivational_message(context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ü–∏—Ç–∞—Ç–∞–º–∏
    cursor.execute('SELECT user_id FROM user_settings WHERE motivational_quotes = TRUE')
    users = cursor.fetchall()
    
    for user in users:
        user_id = user[0]
        
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"üí´ *–ú–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:*\n\n{get_motivational_quote()}",
                parse_mode='Markdown'
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
    
    conn.close()

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    cursor.execute(
        'INSERT OR IGNORE INTO user_settings (user_id) VALUES (?)',
        (user_id,)
    )
    conn.commit()
    conn.close()
    
    keyboard = [
        [InlineKeyboardButton("üìã –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏", callback_data="show_habits")],
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É", callback_data="add_habit")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")],
        [InlineKeyboardButton("üìà –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞", callback_data="show_charts")],
        [InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_message = (
        f"üèÉ‚Äç‚ôÇÔ∏è **–ü—Ä–∏–≤–µ—Ç, {update.effective_user.first_name}!**\n\n"
        f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫!\n\n"
        f"üí´ *–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –º–æ—Ç–∏–≤–∞—Ü–∏—è:*\n{get_motivational_quote()}"
    )
    
    await update.message.reply_text(
        welcome_message,
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
async def show_charts(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute('SELECT habit_name FROM user_habits WHERE user_id = ?', (user_id,))
    habits = cursor.fetchall()
    
    if not habits:
        await query.edit_message_text("–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤.")
        conn.close()
        return
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–∏–≤—ã—á–∫–∞–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    keyboard = []
    for habit in habits:
        habit_name = habit[0]
        keyboard.append([InlineKeyboardButton(f"üìà {habit_name}", callback_data=f"chart_{habit_name}")])
    
    keyboard.append([InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "üìä *–í—ã–±–µ—Ä–∏ –ø—Ä–∏–≤—ã—á–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:*",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )
    
    conn.close()

# –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
async def show_specific_chart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    habit_name = query.data.replace("chart_", "")
    
    # –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    chart_buffer = create_progress_chart(user_id, habit_name, days=14)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
    await context.bot.send_photo(
        chat_id=query.message.chat_id,
        photo=chart_buffer,
        caption=f"üìà **–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏–≤—ã—á–∫–∏:** {habit_name}\n\n"
               f"*–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 14 –¥–Ω–µ–π*\n"
               f"üí´ {get_motivational_quote()}",
        parse_mode='Markdown'
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–Ω–æ–≤–∞
    await show_charts(update, context)

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤—ã—á–µ–∫ —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π
async def show_habits(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    today = date.today().isoformat()
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute('SELECT habit_name FROM user_habits WHERE user_id = ?', (user_id,))
    habits = cursor.fetchall()
    
    if not habits:
        keyboard = [[InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É", callback_data="add_habit")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è. –î–∞–≤–∞–π –¥–æ–±–∞–≤–∏–º –ø–µ—Ä–≤—É—é!",
            reply_markup=reply_markup
        )
        conn.close()
        return
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–∏–≤—ã—á–∫–∞–º–∏
    keyboard = []
    completed_count = 0
    total_count = len(habits)
    
    for habit in habits:
        habit_name = habit[0]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        cursor.execute(
            'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
            (user_id, habit_name, today)
        )
        result = cursor.fetchone()
        status = result[0] if result else "pending"
        
        if status == "completed":
            completed_count += 1
            emoji = "‚úÖ"
        else:
            emoji = "‚è≥"
            
        button_text = f"{emoji} {habit_name}"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"toggle_{habit_name}")])
    
    conn.close()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    keyboard.append([InlineKeyboardButton("üìà –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞", callback_data="show_charts")])
    keyboard.append([InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")])
    keyboard.append([InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    progress_text = ""
    if completed_count == total_count and total_count > 0:
        progress_text = f"\n\nüéâ *–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!*\n{get_motivational_quote()}"
    elif completed_count > 0:
        progress_text = f"\n\nüìä –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: {completed_count}/{total_count} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
    
    await query.edit_message_text(
        f"**–¢–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è** ({date.today().strftime('%d.%m.%Y')}):{progress_text}",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
async def show_settings(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    cursor.execute('SELECT daily_reminder, motivational_quotes FROM user_settings WHERE user_id = ?', (user_id,))
    settings = cursor.fetchone()
    
    daily_reminder = settings[0] if settings else True
    motivational_quotes = settings[1] if settings else True
    
    conn.close()
    
    reminder_status = "‚úÖ –í–ö–õ" if daily_reminder else "‚ùå –í–´–ö–õ"
    quotes_status = "‚úÖ –í–ö–õ" if motivational_quotes else "‚ùå –í–´–ö–õ"
    
    keyboard = [
        [InlineKeyboardButton(f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {reminder_status}", callback_data="toggle_reminders")],
        [InlineKeyboardButton(f"üí´ –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã: {quotes_status}", callback_data="toggle_quotes")],
        [InlineKeyboardButton("üïê –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π", callback_data="change_reminder_time")],
        [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "‚öôÔ∏è *–ù–∞—Å—Ç—Ä–æ–π–∫–∏*\n\n"
        "–ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
async def toggle_setting(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    setting_type = query.data
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    if setting_type == "toggle_reminders":
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        cursor.execute('SELECT daily_reminder FROM user_settings WHERE user_id = ?', (user_id,))
        current = cursor.fetchone()
        new_value = not current[0] if current else False
        
        cursor.execute(
            'UPDATE user_settings SET daily_reminder = ? WHERE user_id = ?',
            (new_value, user_id)
        )
        
        status = "–≤–∫–ª—é—á–µ–Ω—ã" if new_value else "–≤—ã–∫–ª—é—á–µ–Ω—ã"
        await query.answer(f"–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {status}!")
        
    elif setting_type == "toggle_quotes":
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã
        cursor.execute('SELECT motivational_quotes FROM user_settings WHERE user_id = ?', (user_id,))
        current = cursor.fetchone()
        new_value = not current[0] if current else False
        
        cursor.execute(
            'UPDATE user_settings SET motivational_quotes = ? WHERE user_id = ?',
            (new_value, user_id)
        )
        
        status = "–≤–∫–ª—é—á–µ–Ω—ã" if new_value else "–≤—ã–∫–ª—é—á–µ–Ω—ã"
        await query.answer(f"–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã {status}!")
    
    conn.commit()
    conn.close()
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
    await show_settings(update, context)

# –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞)
# [–ó–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏: add_habit, handle_text, toggle_habit, show_stats, show_main_menu]
# –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º
def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º job queue –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    job_queue = application.job_queue
    
    # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 09:00
    job_queue.run_daily(
        send_daily_reminders,
        time=time(hour=9, minute=0, second=0),  # 09:00 —É—Ç—Ä–∞
        name="daily_reminders"
    )
    
    # –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ 18:00
    job_queue.run_daily(
        send_motivational_message,
        time=time(hour=18, minute=0, second=0),  # 18:00 –≤–µ—á–µ—Ä–∞
        name="motivational_messages"
    )
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("menu", show_main_menu))
    application.add_handler(CommandHandler("motivation", lambda u, c: u.message.reply_text(get_motivational_quote())))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback queries
    application.add_handler(CallbackQueryHandler(show_habits, pattern="^show_habits$"))
    application.add_handler(CallbackQueryHandler(add_habit, pattern="^add_habit$"))
    application.add_handler(CallbackQueryHandler(show_stats, pattern="^show_stats$"))
    application.add_handler(CallbackQueryHandler(show_charts, pattern="^show_charts$"))
    application.add_handler(CallbackQueryHandler(show_specific_chart, pattern="^chart_"))
    application.add_handler(CallbackQueryHandler(show_settings, pattern="^settings$"))
    application.add_handler(CallbackQueryHandler(toggle_setting, pattern="^toggle_reminders$|^toggle_quotes$"))
    application.add_handler(CallbackQueryHandler(toggle_habit, pattern="^toggle_"))
    application.add_handler(CallbackQueryHandler(show_main_menu, pattern="^main_menu$"))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("üöÄ –£–ª—É—á—à–µ–Ω–Ω—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    print("üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 09:00")
    print("üí´ –ú–æ—Ç–∏–≤–∞—Ü–∏—è: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 18:00")
    application.run_polling()

if __name__ == '__main__':
    main()

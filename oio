import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import sqlite3
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# 16 –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —Ä—É—Å—Å–∫–∏–º –Ω–∞—Ä–æ–¥–Ω—ã–º —Å–∫–∞–∑–∫–∞–º
QUESTIONS = [
    {
        'question': '1. –ö—Ç–æ –ø–æ–º–æ–≥–∞–ª –∫–ª—É–±–æ—á–∫—É –ø—Ä—è—Ç–∞—Ç—å—Å—è –æ—Ç –ë–∞–±—ã-—è–≥–∏ –≤ —Å–∫–∞–∑–∫–µ "–ì—É—Å–∏-–ª–µ–±–µ–¥–∏"?',
        'options': ['–Ø–±–ª–æ–Ω—è', '–†–µ—á–∫–∞', '–ü–µ—á–∫–∞', '–ú—ã—à–∫–∞'],
        'correct': 2,  # –ü–µ—á–∫–∞
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '2. –ö–∞–∫–æ–µ –≤–æ–ª—à–µ–±–Ω–æ–µ —Å–ª–æ–≤–æ –≥–æ–≤–æ—Ä–∏–ª –ï–º–µ–ª—è, —á—Ç–æ–±—ã —â—É–∫–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞ –µ–≥–æ –∂–µ–ª–∞–Ω–∏—è?',
        'options': ['–ü–æ —â—É—á—å–µ–º—É –≤–µ–ª–µ–Ω–∏—é', '–°–∏–º-—Å–∏–º –æ—Ç–∫—Ä–æ–π—Å—è', '–ö—Ä–µ–∫—Å-—Ñ–µ–∫—Å-–ø–µ–∫—Å', '–†–∞–∑-–¥–≤–∞-—Ç—Ä–∏'],
        'correct': 0,  # –ü–æ —â—É—á—å–µ–º—É –≤–µ–ª–µ–Ω–∏—é
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '3. –ö–æ–≥–æ —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø—É–≥–∞–ª—Å—è –ö–æ–ª–æ–±–æ–∫?',
        'options': ['–ú–µ–¥–≤–µ–¥—è', '–ó–∞–π—Ü–∞', '–í–æ–ª–∫–∞', '–õ–∏—Å—É'],
        'correct': 1,  # –ó–∞–π—Ü–∞
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '4. –ò–∑ –∫–∞–∫–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ —Å–¥–µ–ª–∞–Ω–∞ –ö–∞—â–µ—é –ë–µ—Å—Å–º–µ—Ä—Ç–Ω–æ–º—É —Å–º–µ—Ä—Ç—å?',
        'options': ['–ò–∑ –∫–∞–º–Ω—è', '–ò–∑ —è–π—Ü–∞', '–ò–∑ –∏–≥–ª—ã', '–ò–∑ –∑–µ—Ä–∫–∞–ª–∞'],
        'correct': 2,  # –ò–∑ –∏–≥–ª—ã
        'points': 15,
        'difficulty': '—Å—Ä–µ–¥–Ω–∏–π'
    },
    {
        'question': '5. –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±–æ–≥–∞—Ç—ã—Ä–∏ –±–∏–ª–∏—Å—å —Å –ß—É–¥–æ–º-–Æ–¥–æ–º –≤ —Å–∫–∞–∑–∫–µ "–ò–≤–∞–Ω-–∫—Ä–µ—Å—Ç—å—è–Ω—Å–∫–∏–π —Å—ã–Ω –∏ —á—É–¥–æ-—é–¥–æ"?',
        'options': ['–û–¥–∏–Ω —Ä–∞–∑', '–î–≤–∞ —Ä–∞–∑–∞', '–¢—Ä–∏ —Ä–∞–∑–∞', '–ß–µ—Ç—ã—Ä–µ —Ä–∞–∑–∞'],
        'correct': 2,  # –¢—Ä–∏ —Ä–∞–∑–∞
        'points': 15,
        'difficulty': '—Å—Ä–µ–¥–Ω–∏–π'
    },
    {
        'question': '6. –ß—Ç–æ –ø–æ–ø—Ä–æ—Å–∏–ª–∞ —É —Å—Ç–∞—Ä–∏–∫–∞ –∑–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞ –∑–∞ —Å–≤–æ–µ —Å–ø–∞—Å–µ–Ω–∏–µ?',
        'options': ['–ù–æ–≤—ã–π –¥–æ–º', '–°–≤–æ–±–æ–¥—É', '–ù–∏—á–µ–≥–æ', '–ö–æ—Ä–æ–Ω–∞—Ü–∏—é'],
        'correct': 2,  # –ù–∏—á–µ–≥–æ
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '7. –ö–∞–∫–æ–µ –ø—Ä–æ–∑–≤–∏—â–µ –±—ã–ª–æ —É –ò–≤–∞–Ω–∞ - –º–ª–∞–¥—à–µ–≥–æ —Å—ã–Ω–∞ –≤ —Å–∫–∞–∑–∫–µ "–ö–æ–Ω–µ–∫-–ì–æ—Ä–±—É–Ω–æ–∫"?',
        'options': ['–î—É—Ä–∞–∫', '–£–º–Ω–∏–∫', '–ë–æ–≥–∞—Ç—ã—Ä—å', '–°–∏–ª–∞—á'],
        'correct': 0,  # –î—É—Ä–∞–∫
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '8. –ö—Ç–æ –ø–æ–º–æ–≥ –§–∏–Ω–∏—Å—Ç—É - –Ø—Å–Ω–æ–º—É –°–æ–∫–æ–ª—É –≤–µ—Ä–Ω—É—Ç—å —Å–≤–æ–π –æ–±–ª–∏–∫?',
        'options': ['–ë–∞–±–∞-—è–≥–∞', '–í–∞—Å–∏–ª–∏—Å–∞ –ü—Ä–µ–º—É–¥—Ä–∞—è', '–ú–∞—Ä—å—è-–∏—Å–∫—É—Å–Ω–∏—Ü–∞', '–¶–∞—Ä–µ–≤–Ω–∞-–ª—è–≥—É—à–∫–∞'],
        'correct': 2,  # –ú–∞—Ä—å—è-–∏—Å–∫—É—Å–Ω–∏—Ü–∞
        'points': 20,
        'difficulty': '—Å–ª–æ–∂–Ω—ã–π'
    },
    {
        'question': '9. –ß—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –õ–∏—Å–∞, —á—Ç–æ–±—ã –≤—ã–º–∞–Ω–∏—Ç—å –ü–µ—Ç—É—à–∫–∞ –≤ —Å–∫–∞–∑–∫–µ "–ö–æ—Ç, –ü–µ—Ç—É—Ö –∏ –õ–∏—Å–∞"?',
        'options': ['–ú–µ–¥', '–ü—à–µ–Ω–æ', '–ì–æ—Ä–æ—Ö', '–ó–µ—Ä–∫–∞–ª–æ'],
        'correct': 2,  # –ì–æ—Ä–æ—Ö
        'points': 15,
        'difficulty': '—Å—Ä–µ–¥–Ω–∏–π'
    },
    {
        'question': '10. –ö–∞–∫ –∑–≤–∞–ª–∏ —Å–æ–±–∞–∫—É –≤ —Å–∫–∞–∑–∫–µ "–†–µ–ø–∫–∞"?',
        'options': ['–ñ—É—á–∫–∞', '–ë–∞—Ä–±–æ—Å', '–®–∞—Ä–∏–∫', '–ú—É—Ö—Ç–∞—Ä'],
        'correct': 0,  # –ñ—É—á–∫–∞
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '11. –ß—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ —Ç—Ä–∏ –ø–æ—Ä–æ—Å–µ–Ω–∫–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –≤–æ–ª–∫–∞?',
        'options': ['–î–æ–º –∏–∑ –∫–∞–º–Ω—è', '–î–æ–º –∏–∑ –∫–∏—Ä–ø–∏—á–∞', '–î–æ–º –∏–∑ –¥–µ—Ä–µ–≤–∞', '–î–æ–º –∏–∑ —Å–æ–ª–æ–º—ã'],
        'correct': 0,  # –î–æ–º –∏–∑ –∫–∞–º–Ω—è
        'points': 15,
        'difficulty': '—Å—Ä–µ–¥–Ω–∏–π'
    },
    {
        'question': '12. –ö—Ç–æ –∏–∑ —ç—Ç–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ù–ï —è–≤–ª—è–µ—Ç—Å—è –≥–µ—Ä–æ–µ–º —Ä—É—Å—Å–∫–æ–π –Ω–∞—Ä–æ–¥–Ω–æ–π —Å–∫–∞–∑–∫–∏?',
        'options': ['–ö–æ—â–µ–π –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π', '–ë–∞–±–∞-–Ø–≥–∞', '–ó–º–µ–π –ì–æ—Ä—ã–Ω—ã—á', '–õ–µ—à–∏–π'],
        'correct': 2,  # –ó–º–µ–π –ì–æ—Ä—ã–Ω—ã—á (—Ö–æ—Ç—è –æ–Ω —Ç–æ–∂–µ –µ—Å—Ç—å, –Ω–æ —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π)
        'points': 20,
        'difficulty': '—Å–ª–æ–∂–Ω—ã–π'
    },
    {
        'question': '13. –ß—Ç–æ –∏—Å–∫–∞–ª–∞ –∫—É—Ä–æ—á–∫–∞ –†—è–±–∞ –≤ –æ–¥–Ω–æ–∏–º–µ–Ω–Ω–æ–π —Å–∫–∞–∑–∫–µ?',
        'options': ['–ó–µ—Ä–Ω—ã—à–∫–æ', '–ò–≥–æ–ª–∫—É', '–ö–æ–ª–µ—á–∫–æ', '–Ø–∏—á–∫–æ'],
        'correct': 0,  # –ó–µ—Ä–Ω—ã—à–∫–æ
        'points': 10,
        'difficulty': '–ª–µ–≥–∫–∏–π'
    },
    {
        'question': '14. –ö–µ–º –±—ã–ª –ò–≤–∞–Ω—É—à–∫–∞ –≤ —Å–∫–∞–∑–∫–µ "–°–µ—Å—Ç—Ä–∏—Ü–∞ –ê–ª–µ–Ω—É—à–∫–∞ –∏ –±—Ä–∞—Ç–µ—Ü –ò–≤–∞–Ω—É—à–∫–∞"?',
        'options': ['–ö–æ–∑–ª–µ–Ω–æ—á–µ–∫', '–ñ–µ—Ä–µ–±–µ–Ω–æ—á–µ–∫', '–ë—ã—á–æ–∫', '–ì—É—Å—å'],
        'correct': 0,  # –ö–æ–∑–ª–µ–Ω–æ—á–µ–∫
        'points': 15,
        'difficulty': '—Å—Ä–µ–¥–Ω–∏–π'
    },
    {
        'question': '15. –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å —Ç–µ—Ä–µ–º–∫–æ–º –≤ –∫–æ–Ω—Ü–µ –æ–¥–Ω–æ–∏–º–µ–Ω–Ω–æ–π —Å–∫–∞–∑–∫–∏?',
        'options': ['–°–≥–æ—Ä–µ–ª', '–†–∞–∑–≤–∞–ª–∏–ª—Å—è', '–£–ª–µ—Ç–µ–ª', '–†–∞—Å—Ç–≤–æ—Ä–∏–ª—Å—è'],
        'correct': 1,  # –†–∞–∑–≤–∞–ª–∏–ª—Å—è
        'points': 15,
        'difficulty': '—Å—Ä–µ–¥–Ω–∏–π'
    },
    {
        'question': '16. –ö–∞–∫–æ–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏–ª–∏, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ —Ç—Ä–∏–¥–µ–≤—è—Ç–æ–µ —Ü–∞—Ä—Å—Ç–≤–æ?',
        'options': ['–í—Å—Ç–∞–Ω—å –ø–µ—Ä–µ–¥–æ–º, —Å—Ç–∞–Ω—å –∑–∞–¥–æ–º', '–ü–æ–≤–µ—Ä–Ω–∏—Å—å –Ω–∞ –º–µ—Å—Ç–µ —Ç—Ä–∏ —Ä–∞–∑–∞', '–ü–æ —â—É—á—å–µ–º—É –≤–µ–ª–µ–Ω–∏—é', '–°–∏–º-—Å–∏–º, –æ—Ç–∫—Ä–æ–π—Å—è'],
        'correct': 0,  # –í—Å—Ç–∞–Ω—å –ø–µ—Ä–µ–¥–æ–º, —Å—Ç–∞–Ω—å –∑–∞–¥–æ–º
        'points': 20,
        'difficulty': '—Å–ª–æ–∂–Ω—ã–π'
    }
]

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            total_score INTEGER DEFAULT 0,
            quiz_completed BOOLEAN DEFAULT 0,
            completed_at TIMESTAMP,
            last_played TIMESTAMP,
            current_question INTEGER DEFAULT 0
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_answers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            question_number INTEGER,
            score INTEGER,
            answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    ''')
    
    conn.commit()
    conn.close()

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
def get_or_create_user(user_id, username, first_name, last_name):
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT OR IGNORE INTO users (user_id, username, first_name, last_name) 
        VALUES (?, ?, ?, ?)
    ''', (user_id, username, first_name, last_name))
    
    cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
    user = cursor.fetchone()
    
    conn.commit()
    conn.close()
    return user

def check_quiz_completed(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT quiz_completed FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    
    conn.close()
    return result[0] if result else False

def get_current_question(user_id):
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT current_question FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    
    conn.close()
    return result[0] if result else 0

def set_current_question(user_id, question_num):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE users 
        SET current_question = ?
        WHERE user_id = ?
    ''', (question_num, user_id))
    
    conn.commit()
    conn.close()

def mark_quiz_completed(user_id):
    """–û—Ç–º–µ—á–∞–µ—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE users 
        SET quiz_completed = 1, 
            completed_at = CURRENT_TIMESTAMP,
            current_question = 0
        WHERE user_id = ?
    ''', (user_id,))
    
    conn.commit()
    conn.close()

def save_answer(user_id, question_num, score):
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—á–∞–ª –ª–∏ —É–∂–µ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
    cursor.execute('''
        SELECT COUNT(*) FROM user_answers 
        WHERE user_id = ? AND question_number = ?
    ''', (user_id, question_num))
    
    already_answered = cursor.fetchone()[0] > 0
    
    if already_answered:
        conn.close()
        return False  # –£–∂–µ –æ—Ç–≤–µ—á–∞–ª –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    cursor.execute('''
        INSERT INTO user_answers (user_id, question_number, score)
        VALUES (?, ?, ?)
    ''', (user_id, question_num, score))
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute('''
        UPDATE users 
        SET total_score = (
            SELECT COALESCE(SUM(score), 0) 
            FROM user_answers 
            WHERE user_id = ?
        ),
        last_played = CURRENT_TIMESTAMP,
        current_question = ? + 1
        WHERE user_id = ?
    ''', (user_id, question_num, user_id))
    
    conn.commit()
    conn.close()
    return True

def get_user_score(user_id):
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT total_score FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    
    conn.close()
    return result[0] if result else 0

def get_leaderboard():
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT user_id, username, first_name, last_name, total_score
        FROM users 
        WHERE total_score > 0 AND quiz_completed = 1
        ORDER BY total_score DESC, completed_at ASC
        LIMIT 10
    ''')
    
    leaders = cursor.fetchall()
    conn.close()
    return leaders

def count_completed_questions(user_id):
    """–°—á–∏—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT COUNT(*) FROM user_answers WHERE user_id = ?', (user_id,))
    count = cursor.fetchone()[0]
    
    conn.close()
    return count

def get_user_answers(user_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT question_number, score 
        FROM user_answers 
        WHERE user_id = ? 
        ORDER BY question_number
    ''', (user_id,))
    
    answers = cursor.fetchall()
    conn.close()
    return answers

def get_answered_questions(user_id):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–æ–º–µ—Ä–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏"""
    conn = sqlite3.connect('fairy_tales_quiz.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT question_number FROM user_answers WHERE user_id = ?', (user_id,))
    answers = cursor.fetchall()
    
    conn.close()
    return [a[0] for a in answers]

def get_question_stats():
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º"""
    total_questions = len(QUESTIONS)
    easy_questions = len([q for q in QUESTIONS if q['difficulty'] == '–ª–µ–≥–∫–∏–π'])
    medium_questions = len([q for q in QUESTIONS if q['difficulty'] == '—Å—Ä–µ–¥–Ω–∏–π'])
    hard_questions = len([q for q in QUESTIONS if q['difficulty'] == '—Å–ª–æ–∂–Ω—ã–π'])
    
    total_points = sum(q['points'] for q in QUESTIONS)
    
    return {
        'total': total_questions,
        'easy': easy_questions,
        'medium': medium_questions,
        'hard': hard_questions,
        'total_points': total_points
    }

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    get_or_create_user(user.id, user.username, user.first_name, user.last_name)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    completed = check_quiz_completed(user.id)
    stats = get_question_stats()
    
    if completed:
        welcome_text = f"""
üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user.first_name}!

üìö –í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–æ —Ä—É—Å—Å–∫–∏–º –Ω–∞—Ä–æ–¥–Ω—ã–º —Å–∫–∞–∑–∫–∞–º!

üèÜ –í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: {get_user_score(user.id)} –æ—á–∫–æ–≤
üìä –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['total']}

–í—ã –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–æ–≤—Ç–æ—Ä–Ω–æ.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/score - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π —Å—á–µ—Ç
/leaderboard - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
/results - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
/rules - –ø—Ä–∞–≤–∏–ª–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
        """
    else:
        current_q = get_current_question(user.id)
        answered = count_completed_questions(user.id)
        
        welcome_text = f"""
üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

üìö –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –†–ê–°–®–ò–†–ï–ù–ù–£–Æ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–æ —Ä—É—Å—Å–∫–∏–º –Ω–∞—Ä–æ–¥–Ω—ã–º —Å–∫–∞–∑–∫–∞–º!

‚ú® **–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å {stats['total']} –≤–æ–ø—Ä–æ—Å–∞–º–∏!**
üéØ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å: {stats['total_points']} –æ—á–∫–æ–≤

‚ö†Ô∏è **–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:**
1. –í–∏–∫—Ç–æ—Ä–∏–Ω—É –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!
2. –ù–µ–ª—å–∑—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–æ–ø—Ä–æ—Å–∞–º
3. –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

üìä **–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ –õ–µ–≥–∫–∏–µ ({stats['easy']} —à—Ç.) - 10 –æ—á–∫–æ–≤
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ ({stats['medium']} —à—Ç.) - 15 –æ—á–∫–æ–≤  
‚Ä¢ –°–ª–æ–∂–Ω—ã–µ ({stats['hard']} —à—Ç.) - 20 –æ—á–∫–æ–≤

üìà –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: {answered}/{stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤

üéÆ –ù–∞—á–Ω–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É?

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –Ω–∞—á–∞—Ç—å/–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
/quiz - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
/score - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π —Å—á–µ—Ç
/leaderboard - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
/rules - –ø—Ä–∞–≤–∏–ª–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
        """
    
    keyboard = []
    if not completed:
        keyboard.append([InlineKeyboardButton("üéÆ –ù–∞—á–∞—Ç—å/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", callback_data='start_quiz')])
    
    keyboard.append([InlineKeyboardButton("üìä –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data='show_leaderboard')])
    keyboard.append([InlineKeyboardButton("üìã –ü—Ä–∞–≤–∏–ª–∞", callback_data='show_rules')])
    
    if completed:
        keyboard.append([InlineKeyboardButton("üìà –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data='show_results')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup)

# –ö–æ–º–∞–Ω–¥–∞ /rules
async def rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    completed = check_quiz_completed(user_id)
    answered = count_completed_questions(user_id)
    stats = get_question_stats()
    
    rules_text = f"""
üìã **–ü—Ä–∞–≤–∏–ª–∞ –†–ê–°–®–ò–†–ï–ù–ù–û–ô –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã:**

‚ú® **–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è! –¢–µ–ø–µ—Ä—å {stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤!**

‚ö†Ô∏è **–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
1. –í–∏–∫—Ç–æ—Ä–∏–Ω—É –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó!
2. ‚ùå –ù–ï–õ–¨–ó–Ø –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–æ–ø—Ä–æ—Å–∞–º
3. ‚ùå –ù–ï–õ–¨–ó–Ø –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
4. –û–±–¥—É–º–∞–π—Ç–µ –æ—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º!

üìù **–î–µ—Ç–∞–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã:**
‚Ä¢ –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['total']}
‚Ä¢ –õ–µ–≥–∫–∏–µ: {stats['easy']} –≤–æ–ø—Ä–æ—Å–æ–≤ (10 –æ—á–∫–æ–≤)
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ: {stats['medium']} –≤–æ–ø—Ä–æ—Å–æ–≤ (15 –æ—á–∫–æ–≤)  
‚Ä¢ –°–ª–æ–∂–Ω—ã–µ: {stats['hard']} –≤–æ–ø—Ä–æ—Å–æ–≤ (20 –æ—á–∫–æ–≤)
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: {stats['total_points']} –æ—á–∫–æ–≤

üéÆ **–ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞:**
1. –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∏–º–µ–µ—Ç 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
2. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç
3. –î–≤–∏–≥–∞—Ç—å—Å—è –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥
4. –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
5. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–∫–æ–≤

üèÜ **–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤:**
‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–∏–≤—à–∏–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
‚Ä¢ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—á–∫–∞–º, –∑–∞—Ç–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
‚Ä¢ –ü–µ—Ä–≤—ã–µ —Ç—Ä–∏ –º–µ—Å—Ç–∞ –ø–æ–ª—É—á–∞—é—Ç –º–µ–¥–∞–ª–∏:
  ‚Ä¢ 1 –º–µ—Å—Ç–æ: ü•á –ó–æ–ª–æ—Ç–æ
  ‚Ä¢ 2 –º–µ—Å—Ç–æ: ü•à –°–µ—Ä–µ–±—Ä–æ  
  ‚Ä¢ 3 –º–µ—Å—Ç–æ: ü•â –ë—Ä–æ–Ω–∑–∞

{'üéØ –í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ.' if completed else f'üìä –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: {answered}/{stats["total"]} –≤–æ–ø—Ä–æ—Å–æ–≤'}
"""
    
    keyboard = []
    if not completed:
        keyboard.append([InlineKeyboardButton("üéÆ –ù–∞—á–∞—Ç—å/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", callback_data='start_quiz')])
    
    keyboard.append([InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data='show_leaderboard')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(rules_text, reply_markup=reply_markup)

# –ö–æ–º–∞–Ω–¥–∞ /quiz
async def quiz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    if check_quiz_completed(user_id):
        await update.message.reply_text(
            "‚ùå –í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É! –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /results —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã."
        )
        return
    
    await show_current_question(update, context)

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
async def show_current_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    if check_quiz_completed(user_id):
        if update.callback_query:
            await update.callback_query.answer("–í—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É!", show_alert=True)
        else:
            await update.message.reply_text("–í—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É!")
        return
    
    current_q = get_current_question(user_id)
    answered = get_answered_questions(user_id)
    
    # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    for i in range(len(QUESTIONS)):
        if i not in answered:
            await show_question(update, context, i)
            return
    
    # –ï—Å–ª–∏ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–µ–Ω—ã, –∑–∞–≤–µ—Ä—à–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    mark_quiz_completed(user_id)
    await show_final_results(update, context, user_id)

# –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å
async def show_question(update: Update, context: ContextTypes.DEFAULT_TYPE, question_num):
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    if check_quiz_completed(user_id):
        if update.callback_query:
            await update.callback_query.answer("–í—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–≤–µ—á–∞–ª –ª–∏ —É–∂–µ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
    answered_questions = get_answered_questions(user_id)
    if question_num in answered_questions:
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–π –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        for i in range(question_num + 1, len(QUESTIONS)):
            if i not in answered_questions:
                question_num = i
                break
        else:
            # –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–µ–Ω—ã
            mark_quiz_completed(user_id)
            await show_final_results(update, context, user_id)
            return
    
    question_data = QUESTIONS[question_num]
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
    keyboard = []
    for i, option in enumerate(question_data['options']):
        keyboard.append([InlineKeyboardButton(
            f"{chr(65+i)}) {option}", 
            callback_data=f"answer_{question_num}_{i}"
        )])
    
    # –¢–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º (–Ω–∞–∑–∞–¥ –Ω–µ–ª—å–∑—è!)
    keyboard.append([
        InlineKeyboardButton("üìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data="show_results"),
        InlineKeyboardButton("üèÜ –õ–∏–¥–µ—Ä—ã", callback_data="show_leaderboard")
    ])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
    answered_count = count_completed_questions(user_id)
    stats = get_question_stats()
    
    question_text = f"""
üìù **–í–æ–ø—Ä–æ—Å {question_num + 1} –∏–∑ {stats['total']}**

{question_data['question']}

üí∞ **–°—Ç–æ–∏–º–æ—Å—Ç—å:** {question_data['points']} –æ—á–∫–æ–≤
üéØ **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** {question_data['difficulty']}

**–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:**
A) {question_data['options'][0]}
B) {question_data['options'][1]}
C) {question_data['options'][2]}
D) {question_data['options'][3]}

‚ùå **–í–Ω–∏–º–∞–Ω–∏–µ:** –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ –±—É–¥–µ—Ç –Ω–µ–ª—å–∑—è!

üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {answered_count}/{stats['total']} –æ—Ç–≤–µ—Ç–æ–≤
üèÜ –í–∞—à —Å—á–µ—Ç: {get_user_score(user_id)} –æ—á–∫–æ–≤
    """
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            text=question_text,
            reply_markup=reply_markup
        )
    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
async def handle_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    if check_quiz_completed(user_id):
        await query.answer("–í—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É!", show_alert=True)
        return
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ callback_data
    data = query.data.split('_')
    question_num = int(data[1])
    selected_option = int(data[2])
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–≤–µ—á–∞–ª –ª–∏ —É–∂–µ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
    answered_questions = get_answered_questions(user_id)
    if question_num in answered_questions:
        await query.answer("–í—ã —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!", show_alert=True)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        await show_current_question(update, context)
        return
    
    question_data = QUESTIONS[question_num]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    is_correct = selected_option == question_data['correct']
    score = question_data['points'] if is_correct else 0
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    success = save_answer(user_id, question_num, score)
    
    if not success:
        await query.answer("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞!", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—Ç–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
    answered_count = count_completed_questions(user_id)
    all_answered = answered_count >= len(QUESTIONS)
    stats = get_question_stats()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result_text = f"""
{'‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ!**' if is_correct else '‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!**'}

{'üéâ –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ' + str(score) + ' –æ—á–∫–æ–≤!' if is_correct else 'üìå **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:** ' + question_data['options'][question_data['correct']]}

üìä **–í–∞—à —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç:** {get_user_score(user_id)} –æ—á–∫–æ–≤
üìà **–ü—Ä–æ–≥—Ä–µ—Å—Å:** {answered_count}/{stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤
"""
    
    if not is_correct and score == 0:
        result_text += f"\nüí° **–ó–∞–ø–æ–º–Ω–∏—Ç–µ:** {question_data['options'][question_data['correct']]}"
    
    keyboard = []
    
    if not all_answered:
        keyboard.append([
            InlineKeyboardButton("‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å", callback_data='next_question'),
            InlineKeyboardButton("üìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data="show_results")
        ])
    else:
        # –û—Ç–º–µ—á–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
        mark_quiz_completed(user_id)
        result_text += f"""

üéâ üéâ üéâ **–í–ò–ö–¢–û–†–ò–ù–ê –ó–ê–í–ï–†–®–ï–ù–ê!** üéâ üéâ üéâ

üèÜ **–í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç:** {get_user_score(user_id)} –æ—á–∫–æ–≤ –∏–∑ {stats['total_points']} –≤–æ–∑–º–æ–∂–Ω—ã—Ö!

üìä –í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ {stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤.
–¢–µ–ø–µ—Ä—å –≤–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤!

‚ú® **–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!**

‚ö†Ô∏è –í–∏–∫—Ç–æ—Ä–∏–Ω—É –Ω–µ–ª—å–∑—è –ø—Ä–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ.
"""
        
        keyboard.append([
            InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data="show_leaderboard"),
            InlineKeyboardButton("üìà –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data="show_results")
        ])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(text=result_text, reply_markup=reply_markup)

# –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
async def show_final_results(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id):
    score = get_user_score(user_id)
    answers = get_user_answers(user_id)
    stats = get_question_stats()
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    easy_correct = sum(1 for ans in answers if QUESTIONS[ans[0]]['difficulty'] == '–ª–µ–≥–∫–∏–π' and ans[1] > 0)
    medium_correct = sum(1 for ans in answers if QUESTIONS[ans[0]]['difficulty'] == '—Å—Ä–µ–¥–Ω–∏–π' and ans[1] > 0)
    hard_correct = sum(1 for ans in answers if QUESTIONS[ans[0]]['difficulty'] == '—Å–ª–æ–∂–Ω—ã–π' and ans[1] > 0)
    
    result_text = f"""
üéâ üéâ üéâ **–í–ò–ö–¢–û–†–ò–ù–ê –ó–ê–í–ï–†–®–ï–ù–ê!** üéâ üéâ üéâ

üèÜ **–í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç:** {score} –æ—á–∫–æ–≤ –∏–∑ {stats['total_points']} –≤–æ–∑–º–æ–∂–Ω—ã—Ö!

üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ –õ–µ–≥–∫–∏–µ: {easy_correct}/{stats['easy']} ({easy_correct * 10} –æ—á–∫–æ–≤)
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ: {medium_correct}/{stats['medium']} ({medium_correct * 15} –æ—á–∫–æ–≤)  
‚Ä¢ –°–ª–æ–∂–Ω—ã–µ: {hard_correct}/{stats['hard']} ({hard_correct * 20} –æ—á–∫–æ–≤)

üìù **–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã:**
"""
    
    for i in range(len(QUESTIONS)):
        found = False
        for ans in answers:
            if ans[0] == i:
                q_score = ans[1]
                difficulty = QUESTIONS[i]['difficulty']
                emoji = '‚úÖ' if q_score > 0 else '‚ùå'
                result_text += f"{i+1:2d}. {emoji} ({difficulty}) - {q_score} –æ—á–∫–æ–≤\n"
                found = True
                break
        
        if not found:
            result_text += f"{i+1:2d}. ‚ùì –ù–µ –æ—Ç–≤–µ—á–µ–Ω–æ\n"
    
    result_text += f"""
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéÆ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:** {len([a for a in answers if a[1] > 0])}/{stats['total']}
üìã **–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤:** {stats['total']}

‚ö†Ô∏è –í–∏–∫—Ç–æ—Ä–∏–Ω—É –Ω–µ–ª—å–∑—è –ø—Ä–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ.
"""
    
    keyboard = [
        [InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data="show_leaderboard")],
        [InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="show_rules")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text(text=result_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(result_text, reply_markup=reply_markup)

# –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
async def next_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    await show_current_question(update, context)

# –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
async def show_results(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if query:
        await query.answer()
        user_id = query.from_user.id
    else:
        user_id = update.effective_user.id
    
    score = get_user_score(user_id)
    answers = get_user_answers(user_id)
    completed = check_quiz_completed(user_id)
    answered_count = count_completed_questions(user_id)
    stats = get_question_stats()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    if completed:
        result_text = f"""
üìä **–í–ê–®–ò –§–ò–ù–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:**

üèÜ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: {score} –æ—á–∫–æ–≤ –∏–∑ {stats['total_points']} –≤–æ–∑–º–æ–∂–Ω—ã—Ö
üéØ –°—Ç–∞—Ç—É—Å: –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ
üìä –í–æ–ø—Ä–æ—Å–æ–≤: {stats['total']}
"""
    else:
        result_text = f"""
üìä **–í–ê–®–ò –¢–ï–ö–£–©–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:**

üéØ –¢–µ–∫—É—â–∏–π —Å—á–µ—Ç: {score} –æ—á–∫–æ–≤
üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: {answered_count}/{stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤
‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç—ã
    if answers:
        easy_correct = sum(1 for ans in answers if QUESTIONS[ans[0]]['difficulty'] == '–ª–µ–≥–∫–∏–π' and ans[1] > 0)
        medium_correct = sum(1 for ans in answers if QUESTIONS[ans[0]]['difficulty'] == '—Å—Ä–µ–¥–Ω–∏–π' and ans[1] > 0)
        hard_correct = sum(1 for ans in answers if QUESTIONS[ans[0]]['difficulty'] == '—Å–ª–æ–∂–Ω—ã–π' and ans[1] > 0)
        
        result_text += f"""
üìà **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ –õ–µ–≥–∫–∏–µ: {easy_correct}/{stats['easy']} ({easy_correct * 10} –æ—á–∫–æ–≤)
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ: {medium_correct}/{stats['medium']} ({medium_correct * 15} –æ—á–∫–æ–≤)  
‚Ä¢ –°–ª–æ–∂–Ω—ã–µ: {hard_correct}/{stats['hard']} ({hard_correct * 20} –æ—á–∫–æ–≤)
"""
    
    result_text += f"""
üìù **–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã:**
"""
    
    answered_questions = [a[0] for a in answers]
    
    for i in range(len(QUESTIONS)):
        if i in answered_questions:
            # –ù–∞—Ö–æ–¥–∏–º –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
            for ans in answers:
                if ans[0] == i:
                    q_score = ans[1]
                    difficulty = QUESTIONS[i]['difficulty']
                    emoji = '‚úÖ' if q_score > 0 else '‚ùå'
                    result_text += f"{i+1:2d}. {emoji} ({difficulty}) - {q_score} –æ—á–∫–æ–≤\n"
                    break
        else:
            difficulty = QUESTIONS[i]['difficulty']
            result_text += f"{i+1:2d}. ‚è≥ ({difficulty}) - –µ—â–µ –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∏\n"
    
    result_text += f"""
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéÆ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:** {len([a for a in answers if a[1] > 0])}/{answered_count}
"""
    
    if not completed and answered_count < stats['total']:
        remaining = stats['total'] - answered_count
        result_text += f"\n‚ö†Ô∏è **–û—Å—Ç–∞–ª–æ—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ {remaining} –≤–æ–ø—Ä–æ—Å–æ–≤**"
    
    keyboard = []
    
    if not completed:
        keyboard.append([InlineKeyboardButton(
            "‚û°Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", 
            callback_data='next_question'
        )])
    
    keyboard.append([InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data="show_leaderboard")])
    
    if completed:
        keyboard.append([InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="show_rules")])
    else:
        keyboard.append([InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã", callback_data="show_rules")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(text=result_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(result_text, reply_markup=reply_markup)

# –ö–æ–º–∞–Ω–¥–∞ /results
async def results(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_results(update, context)

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
async def show_leaderboard_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_leaderboard_internal(update, context)

async def show_leaderboard_internal(update: Update, context: ContextTypes.DEFAULT_TYPE, is_callback=False):
    leaders = get_leaderboard()
    user_id = update.effective_user.id if is_callback else update.effective_user.id
    user_score = get_user_score(user_id)
    user_position = None
    stats = get_question_stats()
    
    if not leaders:
        leaderboard_text = f"""
üèÜ **–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –ø—É—Å—Ç–∞!**

üìä –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['total']}
üéØ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: {stats['total_points']} –æ—á–∫–æ–≤

–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –∑–∞–≤–µ—Ä—à–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –≤–∏–∫—Ç–æ—Ä–∏–Ω—É!
"""
    else:
        leaderboard_text = f"""
üèÜ **–¢–û–ü-10 –õ–ò–î–ï–†–û–í** üèÜ

üìä *–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞ ({stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤)*
üéØ *–¢–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–∏–≤—à–∏–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É*

"""
        
        # –ú–µ–¥–∞–ª–∏ –¥–ª—è –ø–µ—Ä–≤—ã—Ö —Ç—Ä–µ—Ö –º–µ—Å—Ç
        medals = ["ü•á", "ü•à", "ü•â"]
        
        for i, (leader_id, username, first_name, last_name, score) in enumerate(leaders):
            medal = medals[i] if i < 3 else f"{i+1}."
            name = f"@{username}" if username else f"{first_name} {last_name or ''}".strip()
            
            # –ü–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if leader_id == user_id:
                name = f"üëâ **{name} (–í—ã)**"
                user_position = i + 1
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            percentage = (score / stats['total_points']) * 100
            leaderboard_text += f"{medal} {name}: {score} –æ—á–∫–æ–≤ ({percentage:.1f}%)\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    leaderboard_text += f"""
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
    
    if user_position:
        leaderboard_text += f"üéØ **–í–∞—à–µ –º–µ—Å—Ç–æ:** {user_position}\n"
    
    leaderboard_text += f"üéØ **–í–∞—à —Å—á–µ—Ç:** {user_score} –æ—á–∫–æ–≤\n"
    percentage = (user_score / stats['total_points']) * 100 if stats['total_points'] > 0 else 0
    leaderboard_text += f"üìä **–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** {percentage:.1f}%\n"
    
    if check_quiz_completed(user_id):
        leaderboard_text += "‚úÖ –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É\n"
    else:
        answered = count_completed_questions(user_id)
        leaderboard_text += f"üìà **–ü—Ä–æ–≥—Ä–µ—Å—Å:** {answered}/{stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤\n"
        leaderboard_text += "‚ö†Ô∏è **–ó–∞–≤–µ—Ä—à–∏—Ç–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤!**\n"
    
    keyboard = []
    user_completed = check_quiz_completed(user_id)
    
    if not user_completed:
        keyboard.append([InlineKeyboardButton("üéÆ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", callback_data='next_question')])
    
    keyboard.append([InlineKeyboardButton("üìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data='show_results')])
    keyboard.append([InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data='show_rules')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if is_callback:
        await update.callback_query.edit_message_text(
            text=leaderboard_text,
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(
            leaderboard_text, 
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )

# –ö–æ–º–∞–Ω–¥–∞ /score
async def score(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    score = get_user_score(user_id)
    completed = check_quiz_completed(user_id)
    answered = count_completed_questions(user_id)
    stats = get_question_stats()
    
    if completed:
        percentage = (score / stats['total_points']) * 100
        score_text = f"""
üìä **–í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: {score} –æ—á–∫–æ–≤**

üéâ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
üìà –†–µ–∑—É–ª—å—Ç–∞—Ç: {percentage:.1f}% –∏–∑ {stats['total_points']} –≤–æ–∑–º–æ–∂–Ω—ã—Ö
üèÜ –í–∞—à–µ –º–µ—Å—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.
"""
    else:
        score_text = f"""
üìä **–í–∞—à —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç: {score} –æ—á–∫–æ–≤**

üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: {answered}/{stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤
üéØ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å: {stats['total_points']} –æ—á–∫–æ–≤
‚ö†Ô∏è –ó–∞–≤–µ—Ä—à–∏—Ç–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É, —á—Ç–æ–±—ã –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤!
"""
    
    keyboard = []
    if not completed:
        keyboard.append([InlineKeyboardButton("üéÆ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", callback_data='next_question')])
    
    keyboard.append([InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data='show_leaderboard')])
    keyboard.append([InlineKeyboardButton("üìä –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data='show_results')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(score_text, reply_markup=reply_markup)

# –ù–∞—á–∞—Ç—å/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
async def start_quiz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
    if check_quiz_completed(user_id):
        await query.answer("–í—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É! –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.", show_alert=True)
        return
    
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    await show_current_question(update, context)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤
async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    
    if data == 'start_quiz':
        await start_quiz(update, context)
    elif data == 'next_question':
        await next_question(update, context)
    elif data.startswith('answer_'):
        await handle_answer(update, context)
    elif data == 'show_results':
        await show_results(update, context)
    elif data == 'show_leaderboard':
        await query.answer()
        await show_leaderboard_internal(update, context, is_callback=True)
    elif data == 'show_rules':
        await query.answer()
        await rules_callback(update, context)

async def rules_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    completed = check_quiz_completed(user_id)
    answered = count_completed_questions(user_id)
    stats = get_question_stats()
    
    rules_text = f"""
üìã **–ü—Ä–∞–≤–∏–ª–∞ –†–ê–°–®–ò–†–ï–ù–ù–û–ô –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã:**

‚ú® **–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è! –¢–µ–ø–µ—Ä—å {stats['total']} –≤–æ–ø—Ä–æ—Å–æ–≤!**

‚ö†Ô∏è **–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
1. –í–∏–∫—Ç–æ—Ä–∏–Ω—É –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó!
2. ‚ùå –ù–ï–õ–¨–ó–Ø –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–æ–ø—Ä–æ—Å–∞–º
3. ‚ùå –ù–ï–õ–¨–ó–Ø –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

üìù **–î–µ—Ç–∞–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã:**
‚Ä¢ –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['total']}
‚Ä¢ –õ–µ–≥–∫–∏–µ: {stats['easy']} –≤–æ–ø—Ä–æ—Å–æ–≤ (10 –æ—á–∫–æ–≤)
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ: {stats['medium']} –≤–æ–ø—Ä–æ—Å–æ–≤ (15 –æ—á–∫–æ–≤)  
‚Ä¢ –°–ª–æ–∂–Ω—ã–µ: {stats['hard']} –≤–æ–ø—Ä–æ—Å–æ–≤ (20 –æ—á–∫–æ–≤)
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: {stats['total_points']} –æ—á–∫–æ–≤

üèÜ **–ù–∞–≥—Ä–∞–¥—ã:**
‚Ä¢ 1 –º–µ—Å—Ç–æ: ü•á –ó–æ–ª–æ—Ç–æ
‚Ä¢ 2 –º–µ—Å—Ç–æ: ü•à –°–µ—Ä–µ–±—Ä–æ  
‚Ä¢ 3 –º–µ—Å—Ç–æ: ü•â –ë—Ä–æ–Ω–∑–∞

{'üéØ –í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ.' if completed else f'üìä –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: {answered}/{stats["total"]} –≤–æ–ø—Ä–æ—Å–æ–≤'}
"""
    
    keyboard = []
    if not completed:
        keyboard.append([InlineKeyboardButton("üéÆ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", callback_data='next_question')])
    
    keyboard.append([InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤", callback_data='show_leaderboard')])
    
    if completed:
        keyboard.append([InlineKeyboardButton("üìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data='show_results')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(text=rules_text, reply_markup=reply_markup)

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token("YOUR_TOKEN_HERE").build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("quiz", quiz))
    application.add_handler(CommandHandler("score", score))
    application.add_handler(CommandHandler("results", results))
    application.add_handler(CommandHandler("leaderboard", show_leaderboard_command))
    application.add_handler(CommandHandler("rules", rules))
    
    application.add_handler(CallbackQueryHandler(handle_callback))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    stats = get_question_stats()
    print("=" * 70)
    print("           –ë–æ—Ç –†–ê–°–®–ò–†–ï–ù–ù–û–ô –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –ø–æ —Ä—É—Å—Å–∫–∏–º –Ω–∞—Ä–æ–¥–Ω—ã–º —Å–∫–∞–∑–∫–∞–º")
    print("=" * 70)
    print(f"üìö –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['total']}")
    print(f"üéØ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª: {stats['total_points']} –æ—á–∫–æ–≤")
    print(f"üìä –°–ª–æ–∂–Ω–æ—Å—Ç—å: –õ–µ–≥–∫–∏–µ - {stats['easy']}, –°—Ä–µ–¥–Ω–∏–µ - {stats['medium']}, –°–ª–æ–∂–Ω—ã–µ - {stats['hard']}")
    print("=" * 70)
    print("‚ö†Ô∏è  –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞:")
    print("1. –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑")
    print("2. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–æ–ø—Ä–æ—Å–∞–º")
    print("3. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏")
    print("4. 16 —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Ä—É—Å—Å–∫–∏–º –Ω–∞—Ä–æ–¥–Ω—ã–º —Å–∫–∞–∑–∫–∞–º")
    print("=" * 70)
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
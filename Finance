#!/usr/bin/env python3
"""
–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è Telegram
–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
"""

import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    CallbackQueryHandler,
    ContextTypes
)
from dotenv import load_dotenv

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

class SimpleFinanceBot:
    def __init__(self):
        self.token = os.getenv('TELEGRAM_BOT_TOKEN')
        if not self.token:
            raise ValueError("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env")
        
        # –ü—Ä–æ—Å—Ç–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ (–¥–ª—è –Ω–∞—á–∞–ª–∞)
        self.user_data = {}
        self.categories = {
            'food': 'üçî –ï–¥–∞',
            'transport': 'üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
            'home': 'üè† –ñ–∏–ª—å–µ',
            'health': 'üíä –ó–¥–æ—Ä–æ–≤—å–µ',
            'entertainment': 'üéÆ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
            'other': 'üì¶ –î—Ä—É–≥–æ–µ'
        }
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user
        
        # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        keyboard = [
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥", callback_data="add_expense")],
            [InlineKeyboardButton("üì• –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥", callback_data="add_income")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")],
            [InlineKeyboardButton("üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="show_categories")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        welcome_text = f"""
üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

üíº **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!

üìã **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**
1. –ù–∞–∂–º–∏—Ç–µ "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥"
2. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É

üí° **–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:**
–ù–∞–ø–∏—à–∏—Ç–µ `150 –µ–¥–∞ –æ–±–µ–¥` –∏–ª–∏ `–¥–æ—Ö–æ–¥ 50000`
        """
        
        await update.message.reply_text(welcome_text, reply_markup=reply_markup)
    
    async def add_expense(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞"""
        query = update.callback_query
        await query.answer()
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        keyboard = []
        for key, value in self.categories.items():
            keyboard.append([InlineKeyboardButton(value, callback_data=f"category_{key}")])
        
        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="main_menu")])
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(
            "üí≥ **–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–∞:**",
            reply_markup=reply_markup
        )
    
    async def handle_category(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        query = update.callback_query
        category = query.data.split('_')[1]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        context.user_data['category'] = category
        category_name = self.categories.get(category, '–î—Ä—É–≥–æ–µ')
        
        await query.edit_message_text(
            f"üìù –í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}\n\n"
            "üíµ **–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞:**\n"
            "–ü—Ä–∏–º–µ—Ä: 1500"
        )
    
    async def handle_text_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        text = update.message.text
        user_id = update.effective_user.id
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id not in self.user_data:
            self.user_data[user_id] = {'expenses': [], 'income': []}
        
        # –ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥
        if text.isdigit():
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª —Å—É–º–º—É
            amount = float(text)
            category = context.user_data.get('category', 'other')
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—Ö–æ–¥
            self.user_data[user_id]['expenses'].append({
                'amount': amount,
                'category': category,
                'category_name': self.categories.get(category, '–î—Ä—É–≥–æ–µ')
            })
            
            await update.message.reply_text(
                f"‚úÖ –†–∞—Å—Ö–æ–¥ {amount} —Ä—É–±. –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "
                f"{self.categories.get(category, '–î—Ä—É–≥–æ–µ')}"
            )
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            await self.show_main_menu(update, context)
            
        elif text.lower().startswith('–¥–æ—Ö–æ–¥'):
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ—Ö–æ–¥–∞
            try:
                amount = float(text.split()[1])
                self.user_data[user_id]['income'].append({'amount': amount})
                await update.message.reply_text(f"‚úÖ –î–æ—Ö–æ–¥ {amount} —Ä—É–±. –¥–æ–±–∞–≤–ª–µ–Ω")
            except (IndexError, ValueError):
                await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: `–¥–æ—Ö–æ–¥ 50000`")
        
        elif any(word in text.lower() for word in ['–µ–¥–∞', '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–¥–æ–º', '–∑–¥–æ—Ä–æ–≤—å–µ', '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è']):
            # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥
            try:
                parts = text.split()
                amount = float(parts[0])
                category = self.parse_category(text.lower())
                
                self.user_data[user_id]['expenses'].append({
                    'amount': amount,
                    'category': category,
                    'category_name': self.categories.get(category, '–î—Ä—É–≥–æ–µ')
                })
                
                await update.message.reply_text(
                    f"‚úÖ –†–∞—Å—Ö–æ–¥ {amount} —Ä—É–±. –¥–æ–±–∞–≤–ª–µ–Ω!\n"
                    f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {self.categories.get(category, '–î—Ä—É–≥–æ–µ')}"
                )
            except (IndexError, ValueError):
                await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: `1500 –µ–¥–∞ –æ–±–µ–¥`")
    
    def parse_category(self, text):
        """–ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        if '–µ–¥–∞' in text:
            return 'food'
        elif '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç' in text:
            return 'transport'
        elif '–¥–æ–º' in text or '–∂–∏–ª—å–µ' in text:
            return 'home'
        elif '–∑–¥–æ—Ä–æ–≤—å–µ' in text:
            return 'health'
        elif '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è' in text:
            return 'entertainment'
        else:
            return 'other'
    
    async def show_stats(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        query = update.callback_query
        user_id = query.from_user.id
        
        if user_id not in self.user_data or not self.user_data[user_id]['expenses']:
            await query.edit_message_text("üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            return
        
        expenses = self.user_data[user_id]['expenses']
        total = sum(item['amount'] for item in expenses)
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        stats = {}
        for expense in expenses:
            cat = expense['category_name']
            stats[cat] = stats.get(cat, 0) + expense['amount']
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = "üìä **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n\n"
        report += f"üí∞ –í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: {total} —Ä—É–±.\n\n"
        
        for category, amount in stats.items():
            percentage = (amount / total) * 100
            bars = "‚ñà" * int(percentage / 10)  # –û–¥–∏–Ω —Å–∏–º–≤–æ–ª = 10%
            report += f"{category}: {amount} —Ä—É–±. ({percentage:.1f}%)\n{bars}\n\n"
        
        keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="main_menu")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(report, reply_markup=reply_markup, parse_mode='Markdown')
    
    async def show_main_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
        if hasattr(update, 'callback_query'):
            query = update.callback_query
            message = query.message
        else:
            message = update.message
        
        keyboard = [
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥", callback_data="add_expense")],
            [InlineKeyboardButton("üì• –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥", callback_data="add_income")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")],
            [InlineKeyboardButton("üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="show_categories")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await message.reply_text(
            "üíº **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é**\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=reply_markup
        )
    
    async def show_categories(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        query = update.callback_query
        await query.answer()
        
        categories_text = "üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:**\n\n"
        for key, value in self.categories.items():
            categories_text += f"{value}\n"
        
        keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="main_menu")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(categories_text, reply_markup=reply_markup)
    
    def setup_handlers(self, application):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
        # –ö–æ–º–∞–Ω–¥—ã
        application.add_handler(CommandHandler("start", self.start))
        
        # Callback-–∫–Ω–æ–ø–∫–∏
        application.add_handler(CallbackQueryHandler(self.add_expense, pattern="^add_expense$"))
        application.add_handler(CallbackQueryHandler(self.show_stats, pattern="^show_stats$"))
        application.add_handler(CallbackQueryHandler(self.show_categories, pattern="^show_categories$"))
        application.add_handler(CallbackQueryHandler(self.show_main_menu, pattern="^main_menu$"))
        application.add_handler(CallbackQueryHandler(self.handle_category, pattern="^category_"))
        
        # –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_text_message))

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –±–æ—Ç–∞...")
    
    try:
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
        bot = SimpleFinanceBot()
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        application = Application.builder().token(bot.token).build()
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        bot.setup_handlers(application)
        
        print("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
        print(f"ü§ñ –¢–æ–∫–µ–Ω: {bot.token[:10]}...")
        print("\nüì± –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:")
        print("1. –û—Ç–∫—Ä—ã—Ç—å Telegram")
        print("2. –ù–∞–π—Ç–∏ –±–æ—Ç–∞ –ø–æ username")
        print("3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /start")
        print("\nüîÑ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
        print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        application.run_polling()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        print("\nüîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –≤ .env —Ñ–∞–π–ª–µ")
        print("2. –ù–∞–ª–∏—á–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")
        print("3. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (pip install python-telegram-bot python-dotenv)")

if __name__ == "__main__":
    main()

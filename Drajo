import sqlite3
import logging
import asyncio
from datetime import datetime, date, timedelta
import random
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
import threading
import time

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –¢–û–ö–ï–ù –ù–ê –°–í–û–ô
BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"

# –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã
MOTIVATIONAL_QUOTES = [
    "üéØ –ú–∞–ª–µ–Ω—å–∫–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –±–æ–ª—å—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º!",
    "üí™ –°–µ–≥–æ–¥–Ω—è —Ç–æ—Ç –¥–µ–Ω—å, –∫–æ–≥–¥–∞ —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –ª—É—á—à–µ, —á–µ–º –≤—á–µ—Ä–∞!",
    "üöÄ –£—Å–ø–µ—Ö ‚Äî —ç—Ç–æ —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π, –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã—Ö –∏–∑–æ –¥–Ω—è –≤ –¥–µ–Ω—å!",
    "üåü –¢—ã –±–ª–∏–∂–µ –∫ —Å–≤–æ–µ–π —Ü–µ–ª–∏, —á–µ–º –±—ã–ª –≤—á–µ—Ä–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
    "üî• –°–∞–º—ã–π –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –±—ã–ª –≥–æ–¥ –Ω–∞–∑–∞–¥. –°–ª–µ–¥—É—é—â–∏–π –ª—É—á—à–∏–π ‚Äî —Å–µ–π—á–∞—Å!",
]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_habits (
            user_id INTEGER,
            habit_name TEXT,
            created_date DATE,
            PRIMARY KEY (user_id, habit_name)
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS habit_progress (
            user_id INTEGER,
            habit_name TEXT,
            date DATE,
            status TEXT DEFAULT 'pending',
            PRIMARY KEY (user_id, habit_name, date)
        )
    ''')
    
    conn.commit()
    conn.close()

def get_motivational_quote():
    return random.choice(MOTIVATIONAL_QUOTES)

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    keyboard = [
        [InlineKeyboardButton("üìã –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏", callback_data="show_habits")],
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É", callback_data="add_habit_menu")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")],
        [InlineKeyboardButton("üí´ –ú–æ—Ç–∏–≤–∞—Ü–∏—è", callback_data="get_motivation")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"üèÉ‚Äç‚ôÇÔ∏è **–ü—Ä–∏–≤–µ—Ç, {update.effective_user.first_name}!**\n\n"
        f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫!\n\n"
        f"üí´ *–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –º–æ—Ç–∏–≤–∞—Ü–∏—è:*\n{get_motivational_quote()}",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤—ã—á–∫–∏
async def show_habits(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    today = date.today().isoformat()
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT habit_name FROM user_habits WHERE user_id = ?', (user_id,))
    habits = cursor.fetchall()
    
    if not habits:
        keyboard = [[InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É", callback_data="add_habit_menu")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "üì≠ –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫.\n\n–î–∞–≤–∞–π –¥–æ–±–∞–≤–∏–º –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!",
            reply_markup=reply_markup
        )
        conn.close()
        return
    
    keyboard = []
    completed_count = 0
    
    for habit in habits:
        habit_name = habit[0]
        
        cursor.execute(
            'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
            (user_id, habit_name, today)
        )
        result = cursor.fetchone()
        status = result[0] if result else "pending"
        
        if status == "completed":
            emoji = "‚úÖ"
            completed_count += 1
        else:
            emoji = "‚è≥"
            
        button_text = f"{emoji} {habit_name}"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"toggle_{habit_name}")])
    
    conn.close()
    
    # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    keyboard.append([InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ", callback_data="add_habit_menu")])
    keyboard.append([InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")])
    keyboard.append([InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    progress_text = ""
    if completed_count == len(habits) and len(habits) > 0:
        progress_text = f"\n\nüéâ *–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Å–µ {len(habits)} –ø—Ä–∏–≤—ã—á–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!*"
    
    await query.edit_message_text(
        f"üìã **–¢–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è** ({date.today().strftime('%d.%m.%Y')})\n"
        f"‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {completed_count} –∏–∑ {len(habits)}{progress_text}",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏
async def toggle_habit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    habit_name = query.data.replace("toggle_", "")
    today = date.today().isoformat()
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    cursor.execute(
        'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
        (user_id, habit_name, today)
    )
    result = cursor.fetchone()
    
    if result and result[0] == "completed":
        cursor.execute(
            'DELETE FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
            (user_id, habit_name, today)
        )
        message = f"‚ùå –û—Ç–º–µ—Ç–∫–∞ —Å '{habit_name}' —Å–Ω—è—Ç–∞"
    else:
        cursor.execute(
            'INSERT OR REPLACE INTO habit_progress (user_id, habit_name, date, status) VALUES (?, ?, ?, ?)',
            (user_id, habit_name, today, "completed")
        )
        message = f"‚úÖ '{habit_name}' –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –ú–æ–ª–æ–¥–µ—Ü! üéâ"
    
    conn.commit()
    conn.close()
    
    await query.answer(message, show_alert=True)
    await show_habits(update, context)

# –ú–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–≤—ã—á–∫–∏
async def add_habit_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    await query.edit_message_text(
        "‚úèÔ∏è *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏*\n\n"
        "–ù–∞–ø–∏—à–∏ –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏.\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: *–ó–∞—Ä—è–¥–∫–∞*, *–ß–∏—Ç–∞—Ç—å 30 –º–∏–Ω—É—Ç*, *–ü–∏—Ç—å –≤–æ–¥—É*\n\n"
        "–ò–ª–∏ –Ω–∞–∂–º–∏ /cancel —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å.",
        parse_mode='Markdown'
    )
    
    context.user_data['awaiting_habit'] = True

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏)
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if context.user_data.get('awaiting_habit'):
        habit_name = update.message.text.strip()
        
        if habit_name.lower() == '/cancel':
            context.user_data['awaiting_habit'] = False
            await update.message.reply_text("‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            await show_main_menu_from_text(update, context)
            return
        
        if len(habit_name) < 2:
            await update.message.reply_text("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
            return
        
        conn = sqlite3.connect('habits.db')
        cursor = conn.cursor()
        
        try:
            cursor.execute(
                'INSERT INTO user_habits (user_id, habit_name, created_date) VALUES (?, ?, ?)',
                (user_id, habit_name, date.today().isoformat())
            )
            conn.commit()
            
            context.user_data['awaiting_habit'] = False
            
            keyboard = [
                [InlineKeyboardButton("üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏", callback_data="show_habits")],
                [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–Ω—É", callback_data="add_habit_menu")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.message.reply_text(
                f"üéâ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–∏–≤—ã—á–∫–∞ '*{habit_name}*' –¥–æ–±–∞–≤–ª–µ–Ω–∞!\n\n"
                f"üí´ {get_motivational_quote()}",
                reply_markup=reply_markup,
                parse_mode='Markdown'
            )
            
        except sqlite3.IntegrityError:
            await update.message.reply_text("‚ùå –≠—Ç–∞ –ø—Ä–∏–≤—ã—á–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.")
        finally:
            conn.close()
    else:
        await update.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º! üòä\n"
            "–ò–ª–∏ –Ω–∞–ø–∏—à–∏ /start –¥–ª—è –Ω–∞—á–∞–ª–∞."
        )

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    today = date.today()
    
    conn = sqlite3.connect('habits.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT habit_name FROM user_habits WHERE user_id = ?', (user_id,))
    habits = cursor.fetchall()
    
    if not habits:
        await query.edit_message_text("üì≠ –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.")
        conn.close()
        return
    
    stats_text = "üìä *–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*\n\n"
    
    for habit in habits:
        habit_name = habit[0]
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        completed_last_7 = 0
        for i in range(7):
            check_date = (today - timedelta(days=i)).isoformat()
            cursor.execute(
                'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
                (user_id, habit_name, check_date)
            )
            result = cursor.fetchone()
            if result and result[0] == "completed":
                completed_last_7 += 1
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        cursor.execute(
            'SELECT COUNT(*) FROM habit_progress WHERE user_id = ? AND habit_name = ? AND status = ?',
            (user_id, habit_name, "completed")
        )
        total_completed = cursor.fetchone()[0]
        
        cursor.execute(
            'SELECT COUNT(DISTINCT date) FROM habit_progress WHERE user_id = ? AND habit_name = ?',
            (user_id, habit_name)
        )
        days_tracked = cursor.fetchone()[0] or 1
        
        percentage = (total_completed / days_tracked) * 100
        
        stats_text += f"*{habit_name}:*\n"
        stats_text += f"‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {total_completed} —Ä–∞–∑\n"
        stats_text += f"üìÖ –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π: {completed_last_7}/7\n"
        stats_text += f"üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {percentage:.1f}%\n\n"
    
    conn.close()
    
    keyboard = [
        [InlineKeyboardButton("üìã –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏", callback_data="show_habits")],
        [InlineKeyboardButton("üí´ –ú–æ—Ç–∏–≤–∞—Ü–∏—è", callback_data="get_motivation")],
        [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        stats_text,
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –ü–æ–ª—É—á–∏—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É
async def get_motivation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        chat_id = query.message.chat_id
    else:
        chat_id = update.message.chat_id
    
    quote = get_motivational_quote()
    
    keyboard = [
        [InlineKeyboardButton("üìã –ö –ø—Ä–∏–≤—ã—á–∫–∞–º", callback_data="show_habits")],
        [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await query.edit_message_text(
            f"üí´ *–ú–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:*\n\n{quote}",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    else:
        await context.bot.send_message(
            chat_id=chat_id,
            text=f"üí´ *–ú–æ—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:*\n\n{quote}",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    keyboard = [
        [InlineKeyboardButton("üìã –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏", callback_data="show_habits")],
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É", callback_data="add_habit_menu")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")],
        [InlineKeyboardButton("üí´ –ú–æ—Ç–∏–≤–∞—Ü–∏—è", callback_data="get_motivation")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "üèÉ‚Äç‚ôÇÔ∏è *–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫*\n\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def show_main_menu_from_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üìã –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏", callback_data="show_habits")],
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É", callback_data="add_habit_menu")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="show_stats")],
        [InlineKeyboardButton("üí´ –ú–æ—Ç–∏–≤–∞—Ü–∏—è", callback_data="get_motivation")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üèÉ‚Äç‚ôÇÔ∏è *–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫*\n\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

# –†—É—á–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ job_queue)
def reminder_thread(bot_token):
    """–ü–æ—Ç–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    from telegram import Bot
    import schedule
    import time
    
    bot = Bot(token=bot_token)
    
    def send_reminders():
        conn = sqlite3.connect('habits.db')
        cursor = conn.cursor()
        
        cursor.execute('SELECT DISTINCT user_id FROM user_habits')
        users = cursor.fetchall()
        
        for user in users:
            user_id = user[0]
            today = date.today().isoformat()
            
            cursor.execute('SELECT habit_name FROM user_habits WHERE user_id = ?', (user_id,))
            habits = cursor.fetchall()
            
            pending_habits = []
            for habit in habits:
                habit_name = habit[0]
                cursor.execute(
                    'SELECT status FROM habit_progress WHERE user_id = ? AND habit_name = ? AND date = ?',
                    (user_id, habit_name, today)
                )
                result = cursor.fetchone()
                if not result or result[0] != "completed":
                    pending_habits.append(habit_name)
            
            if pending_habits:
                habits_text = "\n".join([f"‚Ä¢ {habit}" for habit in pending_habits])
                message = (
                    f"üìã *–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!*\n\n"
                    f"–°–µ–≥–æ–¥–Ω—è –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:\n{habits_text}\n\n"
                    f"üí´ {get_motivational_quote()}"
                )
                
                try:
                    asyncio.run(bot.send_message(
                        chat_id=user_id,
                        text=message,
                        parse_mode='Markdown'
                    ))
                except Exception as e:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
        
        conn.close()
    
    # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 09:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
    schedule.every().day.at("09:00").do(send_reminders)
    
    while True:
        schedule.run_pending()
        time.sleep(60)

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ë–ï–ó job_queue
def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ë–ï–ó job_queue
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("menu", show_main_menu_from_text))
    application.add_handler(CommandHandler("motivation", get_motivation))
    application.add_handler(CommandHandler("remind", lambda u, c: u.message.reply_text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ 09:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å")))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback queries
    application.add_handler(CallbackQueryHandler(show_habits, pattern="^show_habits$"))
    application.add_handler(CallbackQueryHandler(add_habit_menu, pattern="^add_habit_menu$"))
    application.add_handler(CallbackQueryHandler(show_stats, pattern="^show_stats$"))
    application.add_handler(CallbackQueryHandler(get_motivation, pattern="^get_motivation$"))
    application.add_handler(CallbackQueryHandler(show_main_menu, pattern="^main_menu$"))
    application.add_handler(CallbackQueryHandler(toggle_habit, pattern="^toggle_"))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    # –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞ —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
    print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ—Ç–æ–∫ —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    # import threading
    # reminder_thread = threading.Thread(target=reminder_thread, args=(BOT_TOKEN,), daemon=True)
    # reminder_thread.start()
    
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
    print("üì± –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Telegram –∏ –Ω–∞–ø–∏—à–∏—Ç–µ /start")
    application.run_polling()

if __name__ == '__main__':
    main()
